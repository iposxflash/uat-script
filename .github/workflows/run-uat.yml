name: DANA UAT Automation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  uat-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, curl
          tools: composer:v2

      - name: Install Dependencies
        run: |
          cd test/php
          composer install --no-interaction --prefer-dist

      - name: Setup Credentials (Hard-Fix)
        run: |
          # 1. Buat Private Key di Root
          cat <<EOF > private_key.pem
          -----BEGIN RSA PRIVATE KEY-----
          MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQDmO1Gi7/L7e+sn
          Ur21ik0UAvfN6ypBNqG8yd76TpZKU+F61zgxFJXD528zyXllKGUylTL7wp4O02mI
          mWjRF3s2/tUkg/y03S3u2F1zIwf6gl8Sh4A1syq1SnNBuw/r5MF2z5yEiVDLMrZk
          zS8liAMLoPHlxRNK9ax8Z6x0XkrXGk/mmXNW1kzBszUOaAo9bg2gYbLhxgmWj+33
          atef6FcnnTl5DHwG5ftcyI6n0G6gw5J01nib4qtcJp0a2/oeL3VD/OyPhcuLa4K8
          3ERs2e+6jsXtmYMnjqbSFoLZjkkCmNyO21vwtAQEd0oqgEY13TH11lJrHCdoeSmf
          3t1h4p3JAgMBAAECggEAIkDoE/RcM9NLeLXEONrDPft1D+NxjXNJ2/My5A3GKXfS
          X7rehtrXr2Zi8pMCpyy75asyAygA6RbGKEcew6EZOWTvpDeo5OXVXCg/uw4WtUwp
          RfH3/sVR0NgrTre8li2aJQmdcVCWvyyj21p1rcFPJq9C3hsUlD359CZej4+p1dex
          lpGLnABxLO2rUzbLKZ5U4eN6CjaAOIAzkKBVEzuz4rRQt1FY0Zkcxz6p1bln22Dj
          rwadVKP8/48PEvSICmxSlKicaR+ajgL5ZoOB5mgpolvZc72p7V3K1Ueh4O7dmRiT
          Azt5rIkvx8OHRWmxtBxuLOwNTO+5cvvDbVjpgfqcyQKBgQD0hQAWJuWuFbk41ND9
          58txuCoR7zCoB/OK/sSVVsFFLIuaHrFD2mVnQJk/5m9VF0FHnOpBjKn0dElLmw+L
          WQFIlvL+J+VVU2rxSuE2aBm8x7e4F6NaF7RK86ugOhNm/XL6jCY6J1BKXljQ2v8C
          7ESpnQVULntF2xksqxyY61kj1QKBgQDxCpYXMKW/tDzgYnCWdvdVhk2ARKfhKBmb
          wJxXpHyXziQiZtANBmvNCOpEkkV6MA0uFU/2OqA8Cz3hiLxTSEni+nx3mC9nHntG
          A8cIWYbYACAj1c0NviQ1iNcNTIHx1vyvkQlcVc4nqK8V+d/88TEHEiUYadbJJIhs
          WnmmVOawJQKBgG8WVXm65jH2sJV/KguQWT8q2gIX1tUf96c4I3ttVJTmre2w7/vR
          pqwIDxeWyxGvZPrx8QMisrvacMomgiNeplSiL3cEDQ58vWMuD682ECtR2MeMBayS
          hFhg56H9gH8Tuj7VmTBmV/XRcyw/sgdT68XbDma2T07nQUKn4nAey/qZAoGAHzQj
          ofTmQB7xEosr0A6ujh/IwKYipX8vcX5Jvv7IMk65VsrAfC8snWpeCWp2HA9EZYbU
          xydnvt4lsKCm4JEnH38VxdWprUvA4ZtzlJ0iW6wIfRscZH8M6PFCBbK1z7zpEUFR
          WOayvWeU4t9qI7CFjEjJDJQG/hsAniZIQUQUaRECgYBsuKhVo01nmRmrhqzWGbTw
          3gFyEHbaaUGjRlVz/9D23iiOgWMq5H2wN++70RVdMdsV1MLWYAaSWWWrfQmI3sIC
          +f14ozQw3jhaxFfND9IA44yzLpSU1+BwrVniPW0OchZzXskylRKsqhhkP9cHn3Z/
          RMD/d/LTLDNvHcaULQz3SQ==
          -----END RSA PRIVATE KEY-----
          EOF

          # 2. Definisikan Path Absolut
          ABS_PATH=$(pwd)

          # 3. Buat file .env (Menggabungkan format SDK DANA)
          cat <<EOF > .env
          MERCHANT_ID=216620020014045559303
          X_PARTNER_ID=2026021421181946563086
          CLIENT_ID=2026021421181946563086
          CLIENT_SECRET=58439bb51430dd3ea566ae59ff7096d1c8753fe70fa6c4728acbc2bcea2a106e
          EXTERNAL_SHOP_ID=216660000003269467312
          ORIGIN=payment.ojgrup.com
          ENV_TYPE=sandbox
          PRIVATE_KEY_PATH=$ABS_PATH/private_key.pem
          EOF

          # 4. Copy ke folder tempat eksekusi PHPUnit
          cp .env test/php/.env
          cp private_key.pem test/php/private_key.pem

      - name: Install System Dependencies (Chrome & Java)
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          # Chromium akan otomatis terinstall via snap di Ubuntu 24.04
          sudo apt-get install -y chromium-browser chromium-chromedriver
          # Install Java untuk Selenium (Jika run-test.sh membutuhkannya)
          sudo apt-get install -y default-jre

      - name: Run UAT Tests
        env:
          DISPLAY: :99
        run: |
          # Jalankan Xvfb di background
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 3
          
          # Masuk ke direktori test dan jalankan script
          # Kita gunakan sudo -E untuk mempertahankan environment variable
          cd test/php
          sudo -E sh run-test.sh php payment_gateway
