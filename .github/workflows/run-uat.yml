name: DANA UAT Final Boss Mode

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  uat-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer:v2

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb chromium-browser chromium-chromedriver default-jre
          sudo ln -s /usr/lib/chromium-browser/chromedriver /usr/local/bin/chromedriver || true

      - name: Composer Install & Hardcore Injection
        run: |
          TEST_PHP_DIR=$(find . -type d -name "php" | grep "test" | head -n 1)
          cd "$TEST_PHP_DIR"
          composer install --no-interaction --prefer-dist
          
          # DATA CREDENTIALS
          MERCHANT_ID="216620020014045559303"
          CLIENT_ID="2026021421181946563086"
          CLIENT_SECRET="58439bb51430dd3ea566ae59ff7096d1c8753fe70fa6c4728acbc2bcea2a106e"
          RAW_KEY="MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQDmO1Gi7/L7e+snUr21ik0UAvfN6ypBNqG8yd76TpZKU+F61zgxFJXD528zyXllKGUylTL7wp4O02miWjRF3s2/tUkg/y03S3u2F1zIwf6gl8Sh4A1syq1SnNBuw/r5MF2z5yEiVDLMrZkzS8liAMLoPHlxRNK9ax8Z6x0XkrXGk/mmXNW1kzBszUOaAo9bg2gYbLhxgmWj+33atef6FcnnTl5DHwG5ftcyI6n0G6gw5J01nib4qtcJp0a2/oeL3VD/OyPhcuLa4K83ERs2e+6jsXtmYMnjqbSFoLZjkkCmNyO21vwtAQEd0oqgEY13TH11lJrHCdoeSmf3t1h4p3JAgMBAAECggEAIkDoE/RcM9NLeLXEONrDPft1D+NxjXNJ2/My5A3GKXfSX7rehtrXr2Zi8pMCpyy75asyAygA6RbGKEcew6EZOWTvpDeo5OXVXCg/uw4WtUwpRfH3/sVR0NgrTre8li2aJQmdcVCWvyyj21p1rcFPJq9C3hsUlD359CZej4+p1dexpLGLnABxLO2rUzbLKZ5U4eN6CjaAOIAzkKBVEzuz4rRQt1FY0Zkcxz6p1bln22DjrwadVKP8/48PEvSICmxSlKicaR+ajgL5ZoOB5mgpolvZc72p7V3K1Ueh4O7dmRiTAzt5rIkvx8OHRWmxtBxuLOwNTO+5cvvDbVjpgfqcyQKBgQD0hQAWJuWuFbk41ND958txuCoR7zCoB/OK/sSVVsFFLIuaHrFD2mVnQJk/5m9VF0FHnOpBjKn0dElLmw+LWQFIlvL+J+VVU2rxSuE2aBm8x7e4F6NaF7RK86ugOhNm/XL6jCY6J1BKXljQ2v8C7ESpnQVULntF2xksqxyY61kj1QKBgQDxCpYXMKW/tDzgYnCWdvdVhk2ARKfhKBmbwJxXpHyXziQiZtANBmvNCOpEkkV6MA0uFU/2OqA8Cz3hiLxTSEni+nx3mC9nHntGA8cIWYbYACAj1c0NviQ1iNcNTIHx1vyvkQlcVc4nqK8V+d/88TEHEiUYadbJJIhsWnmmVOawJQKBgG8WVXm65jH2sJV/KguQWT8q2gIX1tUf96c4I3ttVJTmre2w7/vRpqwIDxeWyxGvZPrx8QMisrvacMomgiNeplSiL3cEDQ58vWMuD682ECtR2MeMBayShFhg56H9gH8Tuj7VmTBmV/XRcyw/sgdT68XbDma2T07nQUKn4nAey/qZAoGAHzQjofTmQB7xEosr0A6ujh/IwKYipX8vcX5Jvv7IMk65VsrAfC8snWpeCWp2HA9EZYbUxydnvt4lsKCm4JEnH38VxdWprUvA4ZtzlJ0iW6wIfRscZH8M6PFCBbK1z7zpEUFRWOayvWeU4t9qI7CFjEjJDJQG/hsAniZIQUQUaRECgYBsuKhVo01nmRmrhqzWGbTw3gFyEHbaaUGjRlVz/9D23iiOgWMq5H2wN++70RVdMdsV1MLWYAaSWWWrfQmI3sIC+f14ozQw3jhaxFfND9IA44yzLpSU1+BwrVniPW0OchZzXskylRKsqhhkP9cHn3Z/RMD/d/LTLDNvHcaULQz3SQ=="

          # INJEKSI NUKLIR: Langsung ke file Utils/SnapHeader.php
          # Kita paksa variabel $privateKey selalu berisi RAW_KEY kita
          SNAP_HEADER_FILE="vendor/danaid/dana-php/lib/Utils/SnapHeader.php"
          sed -i "s|\$privateKey = Config::get('privateKey');|\$privateKey = '$RAW_KEY';|g" $SNAP_HEADER_FILE
          sed -i "s|\$privateKeyPath = Config::get('privateKeyPath');|\$privateKeyPath = '';|g" $SNAP_HEADER_FILE
          
          # Paksa Config.php juga (untuk Merchant ID & Client ID)
          CONFIG_FILE="vendor/danaid/dana-php/lib/Config/Config.php"
          sed -i "s|self::\$config\[\$key\]|'$MERCHANT_ID'|g" $CONFIG_FILE # Brutal: semua config balik merchant_id dulu, nanti diperbaiki bawah
          
          # Khusus Client ID & Secret
          sed -i "s|return self::\$config\['merchantId'\];|return '$MERCHANT_ID';|g" $CONFIG_FILE
          sed -i "s|return self::\$config\['clientId'\];|return '$CLIENT_ID';|g" $CONFIG_FILE
          sed -i "s|return self::\$config\['clientSecret'\];|return '$CLIENT_SECRET';|g" $CONFIG_FILE

          # Setup Webhook Mock
          cat <<EOF > notify.php
          <?php
          header('Content-Type: application/json');
          echo json_encode(["responseCode" => "2005600", "responseMessage" => "Successful"]);
          EOF
          php -S localhost:8080 > /dev/null 2>&1 &

      - name: Run UAT Tests
        env:
          DISPLAY: :99
        run: |
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 3
          SCRIPT_PATH=$(find . -name "run-test.sh" | head -n 1)
          cd "$(dirname "$SCRIPT_PATH")"
          chmod +x run-test.sh
          # Tambahkan -E untuk membawa environment
          sudo -E ./run-test.sh php payment_gateway
          sudo -E ./run-test.sh php notification
